#
# Deploys the bot resources needed for the Skills Functional Tests.
#

name: "$(Build.BuildId)"
trigger: none
pr: none

pool:
  vmImage: "windows-2019"

parameters:
  ## Azure Resources
  - name: azureSubscription
    displayName: Azure Service Connection
    type: string
    default: $(AZURESUBSCRIPTION)

  - name: appServicePlanGroup
    displayName: App Service Plan Group
    type: string
    default: $(APPSERVICEPLANGROUP)

  - name: appServicePlanGroupLinux
    displayName: App Service Plan Group Linux
    type: string
    default: $(APPSERVICEPLANGROUPLINUX)

  - name: appServicePlanName
    displayName: App Service Plan Name
    type: string
    default: $(APPSERVICEPLANNAME)

  - name: appServicePlanNameLinux
    displayName: App Service Plan Name Linux
    type: string
    default: $(APPSERVICEPLANNAMELINUX)

  - name: botPricingTier
    displayName: 
    type: string
    default: $(BOTPRICINGTIER)
    values:
    - S1
    - F0

  - name: resourceGroup
    displayName: Resource Group
    type: string
    default: $(RESOURCEGROUP)

  - name: resourceSuffix
    displayName: Resource Suffix
    type: string
    default: $(RESOURCESUFFIX)

  ## Bot Configuration
  - name: bffnEchoSkillBotComposerDotNetAppId
    displayName: Echo Skill Bot Composer DotNet App Id
    type: string
    default: $(bffnEchoSkillBotComposerDotNetAppId)

  - name: bffnEchoSkillBotComposerDotNetAppSecret
    displayName: Echo Skill Bot Composer DotNet App Secret
    type: string
    default: $(BffnEchoSkillBotComposerDotNetAppSecret)

  - name: bffnEchoSkillBotDotNet21AppId
    displayName: Echo Skill Bot DotNet 21 App Id
    type: string
    default: $(BffnEchoSkillBotDotNet21AppId)

  - name: bffnEchoSkillBotDotNet21AppSecret
    displayName: Echo Skill Bot DotNet 21 App Secret
    type: string
    default: $(BffnEchoSkillBotDotNet21AppSecret)

  - name: bffnEchoSkillBotDotNetAppId
    displayName: Echo Skill Bot DotNet App Id
    type: string
    default: $(BffnEchoSkillBotDotNetAppId)

  - name: BffnEchoSkillBotDotNetAppSecret
    displayName: Echo Skill Bot DotNet App Secret
    type: string
    default: $(BffnEchoSkillBotDotNetAppSecret)

  - name: bffnEchoSkillBotDotNetV3AppId
    displayName: Echo Skill Bot DotNet V3 App Id
    type: string
    default: $(BffnEchoSkillBotDotNetV3AppId)

  - name: bffnEchoSkillBotDotNetV3AppSecret
    displayName: Echo Skill Bot DotNet V3 App Secret
    type: string
    default: $(BffnEchoSkillBotDotNetV3AppSecret)

  - name: BffnEchoSkillBotJSAppId
    displayName: Echo Skill Bot JS App Id
    type: string
    default: $(BffnEchoSkillBotJSAppId)

  - name: bffnEchoSkillBotJSAppSecret
    displayName: 
    type: string
    default: $(BffnEchoSkillBotJSAppSecret)

  - name: bffnEchoSkillBotJSV3AppId
    displayName: Echo Skill Bot JS V3 App Id
    type: string
    default: $(BffnEchoSkillBotJSV3AppId)

  - name: bffnEchoSkillBotJSV3AppSecret
    displayName: Echo Skill Bot JS V3 App Secret
    type: string
    default: $(BffnEchoSkillBotJSV3AppSecret)

  - name: bffnEchoSkillBotPythonAppId
    displayName: Echo Skill Bot Python App Id
    type: string
    default: $(BffnEchoSkillBotPythonAppId)

  - name: bffnEchoSkillBotPythonAppSecret
    displayName: Echo Skill Bot Python App Secret
    type: string
    default: $(BffnEchoSkillBotPythonAppSecret)

  - name: bffnSimpleHostBotComposerDotNetAppId
    displayName: Simple Host Bot Composer DotNet App Id
    type: string
    default: $(BffnSimpleHostBotComposerDotNetAppId)

  - name: BffnSimpleHostBotComposerDotNetAppSecret
    displayName: 
    type: string
    default: $(BffnSimpleHostBotComposerDotNetAppSecret)

  - name: bffnSimpleHostBotDotNet21AppId
    displayName: Simple Host Bot DotNet 21 App Id
    type: string
    default: $(BffnSimpleHostBotDotNet21AppId)

  - name: bffnSimpleHostBotDotNet21AppSecret
    displayName: Simple Host Bot DotNet 21 App Secret
    type: string
    default: $(BffnSimpleHostBotDotNet21AppSecret)

  - name: 
    displayName: 
    type: string
    default: $()

  - name: 
    displayName: 
    type: string
    default: $()

variables:
  BuildConfiguration: "Debug"
  BuildPlatform: "AnyCPU"

  # - name: BffnSimpleHostBotDotNet21AppId
  #   description: App Id for BffnSimpleHostBotDotNet21 bot.
  #   type: string
  #   optional: true

Muchas variables para mostrar como parametros
Genera confusion en donde deben declararse
La mayoria de las variables no se modifican entre runs
Los parametros se setean para cada run, las variables se setean una sola vez y se usan hasta que se desee cambiarla

  # BffnSimpleHostBotDotNet21AppId: (optional) App Id for BffnSimpleHostBotDotNet21 bot.
  # BffnSimpleHostBotDotNet21AppSecret: (optional) App Secret for BffnSimpleHostBotDotNet21 bot.
  # BffnSimpleHostBotDotNetAppId: (optional) App Id for BffnSimpleHostBotDotNet bot.
  # BffnSimpleHostBotDotNetAppSecret: (optional) App Secret for BffnSimpleHostBotDotNet bot.
  # BffnSimpleHostBotJSAppId: (optional) App Id for BffnSimpleHostBotJS bot.
  # BffnSimpleHostBotJSAppSecret: (optional) App Secret for BffnSimpleHostBotJS bot.
  # BffnSimpleHostBotPythonAppId: (optional) App Id for BffnSimpleHostBotPython bot.
  # BffnSimpleHostBotPythonAppSecret: (optional) App Secret for BffnSimpleHostBotPython bot.
  # BffnWaterfallHostBotDotNetAppId: (optional) App Id for BffnWaterfallHostBotDotNet bot.
  # BffnWaterfallHostBotDotNetAppSecret: (optional) App Secret for BffnWaterfallHostBotDotNet bot.
  # BffnWaterfallSkillBotDotNetAppId: (optional) App Id for BffnWaterfallSkillBotDotNet bot.
  # BffnWaterfallSkillBotDotNetAppSecret: (optional) App Secret for BffnWaterfallSkillBotDotNet bot.
  # BffnWaterfallHostBotJSAppId: (optional) App Id for BffnWaterfallHostBotJS bot.
  # BffnWaterfallHostBotJSAppSecret: (optional) App Secret for BffnWaterfallHostBotJS bot.
  # BffnWaterfallSkillBotJSAppId: (optional) App Id for BffnWaterfallSkillBotJS bot.
  # BffnWaterfallSkillBotJSAppSecret: (optional) App Secret for BffnWaterfallSkillBotJS bot.
  # BffnWaterfallHostBotPythonAppId: (optional) App Id for BffnWaterfallHostBotPython bot.
  # BffnWaterfallHostBotPythonAppSecret: (optional) App Secret for BffnWaterfallHostBotPython bot.
  # BffnWaterfallSkillBotPythonAppId: (optional) App Id for BffnWaterfallSkillBotPython bot.
  # BffnWaterfallSkillBotPythonAppSecret: (optional) App Secret for BffnWaterfallSkillBotPython bot.
  # ConnectionName: (optional) Name for the OAuth connection to use in the skill bots.

  ## Package Dependencies (define in Azure)
  # DependenciesRegistryDotNetHosts: (optional) Registry to download the dependency packages for the DotNet host bots.
  # DependenciesRegistryDotNetSkills: (optional) Registry to download the dependency packages for the DotNet skill bots.
  # DependenciesRegistryDotNetSkillsV3: (optional) Registry to download the dependency packages for the DotNet v3 skill bots.
  # DependenciesVersionDotNetHosts: (optional) Version of the dependency packages for the DotNet host bots.
  # DependenciesVersionDotNetSkills: (optional) Version of the dependency packages for the DotNet skill bots.
  # DependenciesVersionDotNetSkillsV3: (optional) Version of the dependency packages for the DotNet v3 skill bots.
  # DependenciesRegistryJSHosts: (optional) Registry to download the dependency packages for the JS host bots.
  # DependenciesRegistryJSSkills: (optional) Registry to download the dependency packages for the JS skill bots.
  # DependenciesRegistryJSSkillsV3: (optional) Registry to download the dependency packages for the JS v3 skill bots.
  # DependenciesVersionJSHosts: (optional) Version of the dependency packages for the JS host bots.
  # DependenciesVersionJSSkills: (optional) Version of the dependency packages for the JS skill bots.
  # DependenciesVersionJSSkillsV3: (optional) Version of the dependency packages for the JS skill v3 bots.
  # DependenciesRegistryPythonHosts: (optional) Registry to download the dependency packages for the Python host bots.
  # DependenciesRegistryPythonSkills: (optional) Registry to download the dependency packages for the Python skill bots.
  # DependenciesVersionPythonHosts: (optional) Version of the dependency packages for the Python host bots.
  # DependenciesVersionPythonSkills: (optional) Version of the dependency packages for the Python skill bots.

  ## Internal variables
  InternalAppInsightsName: 'bffnappinsights$(InternalResourceSuffix)'
  InternalAppServicePlanLinuxName: $[coalesce(variables['AppServicePlanNameLinux'], 'bffnbotsappservicelinux$(InternalResourceSuffix)')]
  InternalAppServicePlanLinuxResourceGroup: $[coalesce(variables['AppServicePlanGroupLinux'], 'bffnshared-linux')]
  InternalAppServicePlanWindowsName: $[coalesce(variables['AppServicePlanName'], 'bffnbotsappservicewin$(InternalResourceSuffix)')]
  InternalAppServicePlanWindowsResourceGroup: $[coalesce(variables['AppServicePlanGroup'], 'bffnshared')]
  InternalKeyVaultName: 'bffnbotkeyvault$(InternalResourceSuffix)'
  InternalResourceGroupName: $[coalesce(variables['ResourceGroup'], 'bffnbots')]
  InternalResourceSuffix: $[coalesce(variables['ResourceSuffix'], '')]


stages:
# Resource Groups
  - template: common/prepareResources.yml
    parameters:
      azureSubscription: "$(AzureSubscription)"
      resourceGroups: 
        - id: "Prepare_DotNetGroup"
          name: "$(InternalResourceGroupName)-DotNet"
          displayName: "Prepare DotNet's Resource Group"

        - id: "Prepare_JSGroup"
          name: "$(InternalResourceGroupName)-JS"
          displayName: "Prepare JS's Resource Group"

        - id: "Prepare_PythonGroup"
          name: "$(InternalResourceGroupName)-Python"
          displayName: "Prepare Python's Resource Group"

# DotNet
  - template: dotnet/deploy.yml
    parameters:
      appInsight: "$(InternalAppInsightsName)"
      appServicePlan: "$(InternalAppServicePlanWindowsName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BotPricingTier
      connectionName: $env:ConnectionName
      dependsOn: "Prepare_DotNetGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-DotNet"
      resourceSuffix: $(InternalResourceSuffix)
      bots:
        - name: "bffnsimplehostbotdotnet"
          type: "Host"
          displayName: "DotNet Simple Host Bot"
          appId: $(BffnSimpleHostBotDotNetAppId)
          appSecret: $(BffnSimpleHostBotDotNetAppSecret)
          project:
            directory: 'Bots/DotNet/Consumers/CodeFirst/SimpleHostBot'
            name: "SimpleHostBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnsimplehostbotdotnet21"
          type: "Host"
          displayName: "DotNet Simple Host Bot 2.1"
          appId: $(BffnSimpleHostBotDotNet21AppId)
          appSecret: $(BffnSimpleHostBotDotNet21AppSecret)
          project: 
            directory: 'Bots/DotNet/Consumers/CodeFirst/SimpleHostBot-2.1'
            name: "SimpleHostBot-2.1.csproj"
            netCoreVersion: "2.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnechoskillbotdotnet"
          type: "Skill"
          displayName: "DotNet Echo Skill Bot"
          appId: $(BffnEchoSkillBotDotNetAppId)
          appSecret: $(BffnEchoSkillBotDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot'
            name: "EchoSkillBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

        - name: "bffnechoskillbotdotnet21"
          type: "Skill"
          displayName: "DotNet Echo Skill Bot 2.1"
          appId: $(BffnEchoSkillBotDotNet21AppId)
          appSecret: $(BffnEchoSkillBotDotNet21AppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot-2.1'
            name: "EchoSkillBot-2.1.csproj"
            netCoreVersion: "2.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

        - name: "bffnechoskillbotdotnetv3"
          type: "SkillV3"
          displayName: "DotNet Echo Skill Bot v3"
          appId: $(BffnEchoSkillBotDotNetV3AppId)
          appSecret: $(BffnEchoSkillBotDotNetV3AppSecret)
          project:
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot-v3'
            name: "EchoSkillBot-v3.csproj"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkillsV3
            version: $env:DependenciesVersionDotNetSkillsV3

        - name: "bffnwaterfallhostbotdotnet"
          type: "Host"
          displayName: "DotNet Waterfall Host Bot"
          appId: $(BffnWaterfallHostBotDotNetAppId)
          appSecret: $(BffnWaterfallHostBotDotNetAppSecret)
          project:
            directory: 'Bots/DotNet/Consumers/CodeFirst/WaterfallHostBot'
            name: "WaterfallHostBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnwaterfallskillbotdotnet"
          type: "Skill"
          displayName: "DotNet Waterfall Skill Bot"
          appId: $(BffnWaterfallSkillBotDotNetAppId)
          appSecret: $(BffnWaterfallSkillBotDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/WaterfallSkillBot'
            name: "WaterfallSkillBot.csproj"
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

# DotNet Composer
  - template: dotnet/deployComposer.yml
    parameters:
      appInsight: "$(InternalAppInsightsName)"
      appServicePlan: "$(InternalAppServicePlanWindowsName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BotPricingTier
      dependsOn: "Prepare_DotNetGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-DotNet"
      resourceSuffix: $(InternalResourceSuffix)
      bots:
        - name: "bffnsimplehostbotcomposerdotnet"
          type: "Host"
          displayName: "DotNet Simple Composer Host Bot"
          appId: $(BffnSimpleHostBotComposerDotNetAppId)
          appSecret: $(BffnSimpleHostBotComposerDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Consumers/Composer/SimpleHostBotComposer'
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetHosts
            version: $env:DependenciesVersionDotNetHosts

        - name: "bffnechoskillbotcomposerdotnet"
          type: "Skill"
          displayName: "DotNet Echo Composer Skill Bot"
          appId: $(BffnEchoSkillBotComposerDotNetAppId)
          appSecret: $(BffnEchoSkillBotComposerDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/Composer/EchoSkillBotComposer'
            netCoreVersion: "3.1.x"
          dependency:
            registry: $env:DependenciesRegistryDotNetSkills
            version: $env:DependenciesVersionDotNetSkills

# JS
  - template: js/deploy.yml
    parameters:
      appInsight: "$(InternalAppInsightsName)"
      appServicePlan: "$(InternalAppServicePlanWindowsName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BotPricingTier
      connectionName: $env:ConnectionName
      dependsOn: "Prepare_JSGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-JS"
      resourceSuffix: $(InternalResourceSuffix)
      bots:
        - name: "bffnsimplehostbotjs"
          type: "Host"
          displayName: "JS Simple Host Bot"
          appId: $(BffnSimpleHostBotJSAppId)
          appSecret: $(BffnSimpleHostBotJSAppSecret)
          project:
            directory: 'Bots/JavaScript/Consumers/CodeFirst/SimpleHostBot'
          dependency:
            registry: $env:DependenciesRegistryJSHosts
            version: $env:DependenciesVersionJSSHosts

        - name: "bffnechoskillbotjs"
          type: "Skill"
          displayName: "JS Echo Skill Bot"
          appId: $(BffnEchoSkillBotJSAppId)
          appSecret: $(BffnEchoSkillBotJSAppSecret)
          project: 
            directory: 'Bots/JavaScript/Skills/CodeFirst/EchoSkillBot'
          dependency:
            registry: $env:DependenciesRegistryJSSkills
            version: $env:DependenciesVersionJSSkills

        - name: "bffnechoskillbotjsv3"
          type: "SkillV3"
          displayName: "JS Echo Skill Bot v3"
          appId: $(BffnEchoSkillBotJSV3AppId)
          appSecret: $(BffnEchoSkillBotJSV3AppSecret)
          project:
            directory: 'Bots/JavaScript/Skills/CodeFirst/EchoSkillBot-v3'
          dependency:
            registry: $env:DependenciesRegistryJSSkillsV3
            version: $env:DependenciesVersionJSSkillsV3

        - name: "bffnwaterfallhostbotjs"
          type: "Host"
          displayName: "JS Waterfall Host Bot"
          appId: $(BffnWaterfallHostBotJSAppId)
          appSecret: $(BffnWaterfallHostBotJSAppSecret)
          project:
            directory: 'Bots/JavaScript/Consumers/CodeFirst/WaterfallHostBot'
          dependency:
            registry: $env:DependenciesRegistryJSHosts
            version: $env:DependenciesVersionJSSHosts

        - name: "bffnwaterfallskillbotjs"
          type: "Skill"
          displayName: "JS Waterfall Skill Bot"
          appId: $(BffnWaterfallSkillBotJSAppId)
          appSecret: $(BffnWaterfallSkillBotJSAppSecret)
          project: 
            directory: 'Bots/JavaScript/Skills/CodeFirst/WaterfallSkillBot'
          dependency:
            registry: $env:DependenciesRegistryJSSkills
            version: $env:DependenciesVersionJSSkills

# Python
  - template: python/deploy.yml
    parameters:
      appServicePlan: "$(InternalAppServicePlanLinuxName)"
      appServicePlanRG: "$(InternalAppServicePlanLinuxResourceGroup)"
      azureSubscription: "$(AzureSubscription)"
      botPricingTier: $env:BOTPRICINGTIER
      connectionName: $env:CONNECTIONNAME
      dependsOn: "Prepare_PythonGroup"
      keyVault: "$(InternalKeyVaultName)"
      resourceGroup: "$(InternalResourceGroupName)-Python"
      resourceSuffix: "$(InternalResourceSuffix)"
      bots:
        - name: "bffnsimplehostbotpython"
          type: "Host"
          displayName: "Python Simple Host Bot"
          appId: $(BffnSimpleHostBotPythonAppId)
          appSecret: $(BffnSimpleHostBotPythonAppSecret)
          project:
            directory: 'Bots/Python/Consumers/CodeFirst/SimpleHostBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONHOSTS
            version: $env:DEPENDENCIESVERSIONPYTHONHOSTS

        - name: "bffnechoskillbotpython"
          type: "Skill"
          displayName: "Python Echo Skill Bot"
          appId: $(BffnEchoSkillBotPythonAppId)
          appSecret: $(BffnEchoSkillBotPythonAppSecret)
          project: 
            directory: 'Bots/Python/Skills/CodeFirst/EchoSkillBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONSKILLS
            version: $env:DEPENDENCIESVERSIONPYTHONSKILLS

        - name: "bffnwaterfallhostbotpython"
          type: "Host"
          displayName: "Python Waterfall Host Bot"
          appId: $(BffnWaterfallHostBotPythonAppId)
          appSecret: $(BffnWaterfallHostBotPythonAppSecret)
          project:
            directory: 'Bots/Python/Consumers/CodeFirst/WaterfallHostBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONHOSTS
            version: $env:DEPENDENCIESVERSIONPYTHONHOSTS

        - name: "bffnwaterfallskillbotpython"
          type: "Skill"
          displayName: "Python Waterfall Skill Bot"
          appId: $(BffnWaterfallSkillBotPythonAppId)
          appSecret: $(BffnWaterfallSkillBotPythonAppSecret)
          project: 
            directory: 'Bots/Python/Skills/CodeFirst/WaterfallSkillBot'
          dependency:
            registry: $env:DEPENDENCIESREGISTRYPYTHONSKILLS
            version: $env:DEPENDENCIESVERSIONPYTHONSKILLS

# Publish variables
  - stage: "Publish_Variables"
    displayName: "Publish Variables"
    dependsOn: []
    jobs:
      - job: "Publish_Variables"
        displayName: "Publish Variables"
        steps:
          - powershell: |
              $variables = @{
                deploymentBuildSuffix = "$(Build.BuildId)"
              }
              Write-Host $variables
              New-Item -Path "$(System.DefaultWorkingDirectory)" -Name "variables" -ItemType "directory"
              $variables | ConvertTo-Json | Out-File "$(System.DefaultWorkingDirectory)/Variables/variables.json"
            displayName: "Create Variables file"

          - task: PublishPipelineArtifact@1
            displayName: "Publish Variables as artifact"
            inputs:
              targetPath: "$(System.DefaultWorkingDirectory)/variables"
              artifactName: Variables

#
# Deploys the bot resources needed for the Skills Functional Tests.
#

name: $(Build.BuildId)
trigger: none
pr: none

pool:
  vmImage: 'windows-2019'

variables:
  BuildConfiguration: 'Debug'
  BuildPlatform: 'AnyCPU'
  ## Azure Resources (Define these variables in Azure)
  # AzureSubscription: Service Connection Name to Manage Azure resources.
  # AppServicePlanGroup: (optional) Name of the Resource Group where the Windows App Service Plan is located.
  # AppServicePlanGroupLinux: (optional) Name of the Resource Group where the Linux App Service Plan is located.
  # AppServicePlanName: (optional) Name of the Windows App Service Plan.
  # AppServicePlanNameLinux: (optional) Name of the Linux App Service Plan.
  # BotPricingTier: (optional) Pricing Tier for the bots, default F0.
  # ResourceGroup: (optional) Name of the Resource Group where the bots will be deployed.
  # ResourceSuffix: (optional) Suffix to add to the resources' name to avoid collitions.

  ## Bots Configuration (Define these variables in Azure)
  # BffnEchoSkillBotComposerDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotComposerDotNetAppSecret: (optional) App Secret for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNet21AppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNet21AppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNetAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNetV3AppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotDotNetV3AppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotJSAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotJSAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotJSV3AppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotJSV3AppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotPythonAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnEchoSkillBotPythonAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotComposerDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotComposerDotNetAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotDotNet21AppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotDotNet21AppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotDotNetAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotJSAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotJSAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotPythonAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnSimpleHostBotPythonAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallHostBotDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallHostBotDotNetAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallSkillBotDotNetAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallSkillBotDotNetAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallHostBotJSAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallHostBotJSAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallSkillBotJSAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallSkillBotJSAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallHostBotPythonAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallHostBotPythonAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallSkillBotPythonAppId: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # BffnWaterfallSkillBotPythonAppSecret: (optional) App Id for BffnEchoSkillBotComposerDotNet bot.
  # ConnectionName: (optional) define in Azure
  ## Package Dependencies variables
  # DependenciesRegistryHosts: (optional) define in Azure
  # DependenciesRegistrySkills: (optional) define in Azure
  # DependenciesRegistrySkillsV3: (optional) define in Azure
  # DependenciesVersionHosts: (optional) define in Azure
  # DependenciesVersionSkills: (optional) define in Azure
  # DependenciesVersionSkillsV3: (optional) define in Azure
  ## Internal variables
  InternalResourceSuffix: $[coalesce(variables['ResourceSuffix'], '')]
  InternalAppInsightsName: 'bffnappinsights$(InternalResourceSuffix)'
  InternalAppServicePlanLinuxName: $[coalesce(variables['AppServicePlanNameLinux'], 'bffnbotsappservicelinux$(InternalResourceSuffix)')]
  InternalAppServicePlanLinuxResourceGroup: $[coalesce(variables['AppServicePlanGroupLinux'], 'bffnshared-linux')]
  InternalAppServicePlanWindowsName: $[coalesce(variables['AppServicePlanName'], 'bffnbotsappservicewin$(InternalResourceSuffix)')]
  InternalAppServicePlanWindowsResourceGroup: $[coalesce(variables['AppServicePlanGroup'], 'bffnshared')]
  InternalKeyVaultName: 'bffnbotkeyvault$(InternalResourceSuffix)'
  InternalResourceGroupName: $[coalesce(variables['ResourceGroup'], 'bffnbots')]


stages:
# Resource Groups
  - template: common/prepareResources.yml
    parameters:
      resourceGroups: 
        - id: 'Prepare_DotNetGroup'
          name: "$(InternalResourceGroupName)-DotNet"
          displayName: "Prepare DotNet's Resource Group"

        - id: 'Prepare_JSGroup'
          name: "$(InternalResourceGroupName)-JS"
          displayName: "Prepare JS's Resource Group"

        - id: 'Prepare_PythonGroup'
          name: "$(InternalResourceGroupName)-Python"
          displayName: "Prepare Python's Resource Group"

# DotNet
  - template: dotnet/deploy.yml
    parameters:
      dependsOn: "Prepare_DotNetGroup"
      resourceGroup: "$(InternalResourceGroupName)-DotNet"
      botPricingTier: $env:BotPricingTier
      resourceSuffix: $env:ResourceSuffix
      appServicePlan: "$(InternalAppServicePlanWindowsName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      appInsight: "$(InternalAppInsightsName)"
      connectionName: $env:ConnectionName
      keyVault: "$(InternalKeyVaultName)"
      bots:
        - name: bffnsimplehostbotdotnet
          type: 'Host'
          displayName: 'DotNet Simple Host Bot'
          appId: $(BffnSimpleHostBotDotNetAppId)
          appSecret: $(BffnSimpleHostBotDotNetAppSecret)
          project:
            directory: 'Bots/DotNet/Consumers/CodeFirst/SimpleHostBot'
            name: 'SimpleHostBot.csproj'
            netCoreVersion: '3.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnsimplehostbotdotnet21
          type: 'Host'
          displayName: 'DotNet Simple Host Bot 2.1'
          appId: $(BffnSimpleHostBotDotNet21AppId)
          appSecret: $(BffnSimpleHostBotDotNet21AppSecret)
          project: 
            directory: 'Bots/DotNet/Consumers/CodeFirst/SimpleHostBot-2.1'
            name: 'SimpleHostBot-2.1.csproj'
            netCoreVersion: '2.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnechoskillbotdotnet
          type: 'Skill'
          displayName: 'DotNet Echo Skill Bot'
          appId: $(BffnEchoSkillBotDotNetAppId)
          appSecret: $(BffnEchoSkillBotDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot'
            name: 'EchoSkillBot.csproj'
            netCoreVersion: '3.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

        - name: bffnechoskillbotdotnet21
          type: 'Skill'
          displayName: 'DotNet Echo Skill Bot 2.1'
          appId: $(BffnEchoSkillBotDotNet21AppId)
          appSecret: $(BffnEchoSkillBotDotNet21AppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot-2.1'
            name: 'EchoSkillBot-2.1.csproj'
            netCoreVersion: '2.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

        - name: bffnechoskillbotdotnetv3
          type: 'SkillV3'
          displayName: 'DotNet Echo Skill Bot v3'
          appId: $(BffnEchoSkillBotDotNetV3AppId)
          appSecret: $(BffnEchoSkillBotDotNetV3AppSecret)
          project:
            directory: 'Bots/DotNet/Skills/CodeFirst/EchoSkillBot-v3'
            name: 'EchoSkillBot-v3.csproj'
          dependenciesRegistry: "$($env:DependenciesRegistrySkillsV3)"
          dependenciesVersion: "$($env:DependenciesVersionSkillsV3)"

        - name: bffnwaterfallhostbotdotnet
          type: 'Host'
          displayName: 'DotNet Waterfall Host Bot'
          appId: $(BffnWaterfallHostBotDotNetAppId)
          appSecret: $(BffnWaterfallHostBotDotNetAppSecret)
          project:
            directory: 'Bots/DotNet/Consumers/CodeFirst/WaterfallHostBot'
            name: 'WaterfallHostBot.csproj'
            netCoreVersion: '3.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnwaterfallskillbotdotnet
          type: 'Skill'
          displayName: 'DotNet Waterfall Skill Bot'
          appId: $(BffnWaterfallSkillBotDotNetAppId)
          appSecret: $(BffnWaterfallSkillBotDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/CodeFirst/WaterfallSkillBot'
            name: 'WaterfallSkillBot.csproj'
            netCoreVersion: '3.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

# DotNet Composer
  - template: dotnet/deployComposer.yml
    parameters:
      dependsOn: "Prepare_DotNetGroup"
      resourceGroup: "$(InternalResourceGroupName)-DotNet"
      botPricingTier: $env:BotPricingTier
      resourceSuffix: $env:ResourceSuffix
      appServicePlan: "$(InternalAppServicePlanWindowsName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      appInsight: "$(InternalAppInsightsName)"
      keyVault: "$(InternalKeyVaultName)"
      bots:
        - name: bffnsimplehostbotcomposerdotnet
          type: 'Host'
          displayName: 'DotNet Simple Composer Host Bot'
          appId: $(BffnSimpleHostBotComposerDotNetAppId)
          appSecret: $(BffnSimpleHostBotComposerDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Consumers/Composer/SimpleHostBotComposer'
            netCoreVersion: '3.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnechoskillbotcomposerdotnet
          type: 'Skill'
          displayName: 'DotNet Echo Composer Skill Bot'
          appId: $(BffnEchoSkillBotComposerDotNetAppId)
          appSecret: $(BffnEchoSkillBotComposerDotNetAppSecret)
          project: 
            directory: 'Bots/DotNet/Skills/Composer/EchoSkillBotComposer'
            netCoreVersion: '3.1.x'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

# JS
  - template: js/deploy.yml
    parameters:
      dependsOn: "Prepare_JSGroup"
      resourceGroup: "$(InternalResourceGroupName)-JS"
      botPricingTier: $env:BotPricingTier
      resourceSuffix: $env:ResourceSuffix
      appServicePlan: "$(InternalAppServicePlanWindowsName)"
      appServicePlanRG: "$(InternalAppServicePlanWindowsResourceGroup)"
      appInsight: "$(InternalAppInsightsName)"
      connectionName: $env:ConnectionName
      keyVault: "$(InternalKeyVaultName)"
      bots:
        - name: bffnsimplehostbotjs
          type: 'Host'
          displayName: 'JS Simple Host Bot'
          appId: $(BffnSimpleHostBotJSAppId)
          appSecret: $(BffnSimpleHostBotJSAppSecret)
          project:
            directory: 'Bots/JavaScript/Consumers/CodeFirst/SimpleHostBot'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnechoskillbotjs
          type: 'Skill'
          displayName: 'JS Echo Skill Bot'
          appId: $(BffnEchoSkillBotJSAppId)
          appSecret: $(BffnEchoSkillBotJSAppSecret)
          project: 
            directory: 'Bots/JavaScript/Skills/CodeFirst/EchoSkillBot'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

        - name: bffnechoskillbotjsv3
          type: 'SkillV3'
          displayName: 'JS Echo Skill Bot v3'
          appId: $(BffnEchoSkillBotJSV3AppId)
          appSecret: $(BffnEchoSkillBotJSV3AppSecret)
          project:
            directory: 'Bots/JavaScript/Skills/CodeFirst/EchoSkillBot-v3'
          dependenciesRegistry: "$($env:DependenciesRegistrySkillsV3)"
          dependenciesVersion: "$($env:DependenciesVersionSkillsV3)"

        - name: bffnwaterfallhostbotjs
          type: 'Host'
          displayName: 'JS Waterfall Host Bot'
          appId: $(BffnWaterfallHostBotJSAppId)
          appSecret: $(BffnWaterfallHostBotJSAppSecret)
          project:
            directory: 'Bots/JavaScript/Consumers/CodeFirst/WaterfallHostBot'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnwaterfallskillbotjs
          type: 'Skill'
          displayName: 'JS Waterfall Skill Bot'
          appId: $(BffnWaterfallSkillBotJSAppId)
          appSecret: $(BffnWaterfallSkillBotJSAppSecret)
          project: 
            directory: 'Bots/JavaScript/Skills/CodeFirst/WaterfallSkillBot'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

# Python
  - template: python/deploy.yml
    parameters:
      dependsOn: "Prepare_PythonGroup"
      resourceGroup: "$(InternalResourceGroupName)-Python"
      botPricingTier: $env:BOTPRICINGTIER
      resourceSuffix: $env:RESOURCESUFFIX
      appServicePlan: "$(InternalAppServicePlanLinuxName)"
      appServicePlanRG: "$(InternalAppServicePlanLinuxResourceGroup)"
      connectionName: $env:CONNECTIONNAME
      keyVault: "$(InternalKeyVaultName)"
      bots:
        - name: bffnsimplehostbotpython
          type: 'Host'
          displayName: 'Python Simple Host Bot'
          appId: $(BffnSimpleHostBotPythonAppId)
          appSecret: $(BffnSimpleHostBotPythonAppSecret)
          project:
            directory: 'Bots/Python/Consumers/CodeFirst/SimpleHostBot'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnechoskillbotpython
          type: 'Skill'
          displayName: 'Python Echo Skill Bot'
          appId: $(BffnEchoSkillBotPythonAppId)
          appSecret: $(BffnEchoSkillBotPythonAppSecret)
          project: 
            directory: 'Bots/Python/Skills/CodeFirst/EchoSkillBot'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

        - name: bffnwaterfallhostbotpython
          type: 'Host'
          displayName: 'Python Waterfall Host Bot'
          appId: $(BffnWaterfallHostBotPythonAppId)
          appSecret: $(BffnWaterfallHostBotPythonAppSecret)
          project:
            directory: 'Bots/Python/Consumers/CodeFirst/WaterfallHostBot'
          dependenciesRegistry: "$($env:DependenciesRegistryHosts)"
          dependenciesVersion: "$($env:DependenciesVersionHosts)"

        - name: bffnwaterfallskillbotpython
          type: 'Skill'
          displayName: 'Python Waterfall Skill Bot'
          appId: $(BffnWaterfallSkillBotPythonAppId)
          appSecret: $(BffnWaterfallSkillBotPythonAppSecret)
          project: 
            directory: 'Bots/Python/Skills/CodeFirst/WaterfallSkillBot'
          dependenciesRegistry: "$($env:DependenciesRegistrySkills)"
          dependenciesVersion: "$($env:DependenciesVersionSkills)"

# Publish variables
  - stage: 'Publish_Variables'
    displayName: 'Publish Variables'
    dependsOn: []
    jobs:
      - job: 'Publish_Variables'
        displayName: 'Publish Variables'
        steps:
          - powershell: |
              $variables = @{
                deploymentBuildSuffix = "$(Build.BuildId)"
              }
              Write-Host $variables
              New-Item -Path "$(System.DefaultWorkingDirectory)" -Name "variables" -ItemType "directory"
              $variables | ConvertTo-Json | Out-File "$(System.DefaultWorkingDirectory)/Variables/variables.json"
            displayName: 'Create Variables file'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Variables as artifact'
            inputs:
              targetPath: $(System.DefaultWorkingDirectory)/variables
              artifactName: Variables
